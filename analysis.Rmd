---
title: "Analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Imports
```{r message=FALSE}
library(mgcv)
library(tidyverse)
library(caret)
library(mice)


df <- read.csv("data/train_simple.csv", stringsAsFactors = TRUE)
df <- select(df, -coverage)  # Doesn't seem particularly useful
```

## Impute income variable
As lots of the incomes are zero, it makes sense to impute these, as employment status is a categorical variable anyway.
```{r message=FALSE}
df_big <- read.csv("data/train.csv", stringsAsFactors = TRUE)
df_big <- df_big %>% select(-Country, -Customer)
df_big$Income[df_big$Income == 0] <- NA

imputations <- complete(mice(df_big, method = "pmm", seed=1))

df$income <- imputations$Income
```

```{r}
head(df)
```


## Look at linear regression for baseline
```{r}
res <- lm(total_claim_amount ~ employment_status + location_code + 
             vehicle_class + income + monthly_premium_auto +
             employment_status*monthly_premium_auto + 
             location_code*monthly_premium_auto, data = df)

summary(res)
```
Could be worth using robust regression if aim is minimizing absolute difference.

## GAM
Does using a GAM improve this:
```{r}
res <- gam(total_claim_amount ~ employment_status + location_code + 
             vehicle_class + s(income) + s(monthly_premium_auto) +
             employment_status*monthly_premium_auto + 
             location_code*monthly_premium_auto,
           data = df)
summary(res)
```

Default GAM doesn't help much with this default model. Perhaps this is due to the fact mostly linear relationship (from EDA) plots this could be reasonable.

```{r}
res <- gam(total_claim_amount ~ employment_status + location_code + 
             vehicle_class + s(income) +
             s(monthly_premium_auto, by = employment_status) +
             s(monthly_premium_auto, by = location_code), data = df)

summary(res)
```
Hmmm seems to do about the same, but I don't really know what I am doing. Need to check models with MAE and CV, maybe consider robust regression or quantreg as we are interested in absolute error.

Median regression is a thing https://cran.r-project.org/web/packages/quantreg/vignettes/rq.pdf. This will probably work better for absolute error?



